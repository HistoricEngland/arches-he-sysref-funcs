
services:
    nginx-archeshesysreffuncs:
      container_name: nginx-archeshesysreffuncs
      image: nginx:latest
      ports:
        - "8080:80"
      volumes:
        - ./docker/nginx-config/default.conf:/etc/nginx/conf.d/default.conf
      networks:
        - archeshesysreffuncs-network

    db-archeshesysreffuncs:
      container_name: db-archeshesysreffuncs
      image: postgis/postgis:14-3.2
      volumes:
        - ../../arches_he_sysref_funcs-postgres-data:/var/lib/postgresql/data
        - ../../arches_he_sysref_funcs-postgres-log:/var/log/postgresql
        - ./docker/init-unix.sql:/docker-entrypoint-initdb.d/init.sql # to set up the DB template
      ports:
        - '5433:5432'
      env_file: 
        - ./docker/env_file.env
      networks:
        - archeshesysreffuncs-network

    elastic-bindmount-init-archeshesysreffuncs:
      image: alpine
      container_name: elastic-bindmount-init-archeshesysreffuncs
      restart: "no"
      entrypoint: |
        /bin/sh -c "chown 1000:1000 /esBindMount"
      volumes:
        - ../../arches_he_sysref_funcs-elasticsearch-data:/esBindMount


    elasticsearch-archeshesysreffuncs:
      container_name: elasticsearch-archeshesysreffuncs
      image: elasticsearch:8.5.0
      volumes:
        #- ../../elasticsearch_data_arches_he_sysref_funcs:/usr/share/elasticsearch/data
        - ../../arches_he_sysref_funcs-elasticsearch-data:/usr/share/elasticsearch/data
      ports:
        - "9201:9200"
        - "9301:9300"
      env_file: 
        - ./docker/env_file.env
      networks:
        - archeshesysreffuncs-network
      depends_on:
        - elastic-bindmount-init-archeshesysreffuncs

    rabbitmq-archeshesysreffuncs:
      container_name: rabbitmq-archeshesysreffuncs
      image: rabbitmq:3.8-management
      hostname: my-rabbit
      volumes:
        - rabbitmq-data:/var/lib/rabbitmq/mnesia/rabbit@my-rabbit
        - rabbitmq-logs:/var/log/rabbitmq/log
      ports:
        - 5673:5672
        - 15673:15672
      networks:
        - archeshesysreffuncs-network

    #pg-feat-archeshesysreffuncs:
    #  container_name: pg-feat-archeshesysreffuncs
    #  image: pramsey/pg_featureserv
    #  volumes:
    #    - ../../pg_featureserv_config_arches_he_sysref_funcs:/config
    #  environment:
    #    - DATABASE_URL=postgresql://arches_spatial_views:arches_spatial_views@db-archeshesysreffuncs:5432/arches_he_sysref_funcs
    #  ports:
    #    - 9000:9000
    #  networks:
    #    - archeshesysreffuncs-network
    #  depends_on:
    #    - db-archeshesysreffuncs
    
    #pg-tile-archeshesysreffuncs:
    #  container_name: pg-tile-archeshesysreffuncs
    #  image: pramsey/pg_tileserv
    #  volumes:
    #    - ../../pg_tileserv_config_arches_he_sysref_funcs:/config
    #  environment:
    #    - DATABASE_URL=postgresql://arches_spatial_views:arches_spatial_views@db-archeshesysreffuncs:5432/arches_he_sysref_funcs
    #  ports:
    #    - 7800:7800
    #  networks:
    #    - archeshesysreffuncs-network
    #  depends_on:
    #    - db-archeshesysreffuncs


networks:
  archeshesysreffuncs-network:
    name: archeshesysreffuncs-network
    driver: bridge

volumes:
    rabbitmq-logs:
    rabbitmq-data: